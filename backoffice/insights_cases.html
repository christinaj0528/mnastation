<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<title>M&A 사례 관리 | M&A STATION</title>
<link rel="stylesheet" href="https://macomaex.com/backoffice/vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://macomaex.com/backoffice/build/css/custom.min.css" rel="stylesheet">
<style>
  .admin-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
  }
  .board-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
  }
  .btn-primary {
    background: #4db7ff;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    color: white;
    cursor: pointer;
  }
  .board-table {
    width: 100%;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .board-table th {
    background: #f5f5f5;
    padding: 15px;
    text-align: left;
    font-weight: 600;
  }
  .board-table td {
    padding: 15px;
    border-top: 1px solid #eee;
  }
  .board-table tr:hover {
    background: #f9f9f9;
  }
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    overflow-y: auto;
    padding: 20px;
  }
  .modal-content {
    background: white;
    max-width: 800px;
    margin: 0 auto;
    padding: 30px;
    border-radius: 12px;
  }
  .form-group {
    margin-bottom: 20px;
  }
  .form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
  }
  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }
  .form-group textarea {
    min-height: 200px;
    resize: vertical;
  }
  .file-preview {
    margin-top: 10px;
    padding: 10px;
    background: #f9f9f9;
    border-radius: 6px;
    font-size: 12px;
  }
  .file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px solid #eee;
  }
  .file-item:last-child {
    border-bottom: none;
  }
  .file-item-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .file-item-remove {
    color: #ff5757;
    cursor: pointer;
    margin-left: 10px;
  }
</style>
</head>
<body>
  <div class="admin-container">
    <div class="board-header">
      <h2>M&A 사례 관리</h2>
      <button class="btn-primary" onclick="openAddModal()">+ 새 사례 등록</button>
    </div>

    <table class="board-table">
      <thead>
        <tr>
          <th style="width: 80px;">번호</th>
          <th>제목</th>
          <th style="width: 150px;">작성일</th>
          <th style="width: 120px;">관리</th>
        </tr>
      </thead>
      <tbody id="casesList">
        <tr>
          <td colspan="4" style="text-align: center; padding: 40px;">등록된 사례가 없습니다.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- 등록/수정 모달 -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <h3 id="modalTitle">새 사례 등록</h3>
      <form id="caseForm" onsubmit="saveCase(event)">
        <input type="hidden" id="caseId">
        <div class="form-group">
          <label>제목 *</label>
          <input type="text" id="caseTitle" required>
        </div>
        <div class="form-group">
          <label>설명</label>
          <textarea id="caseDescription"></textarea>
        </div>
        <div class="form-group">
          <label>내용</label>
          <textarea id="caseContent"></textarea>
        </div>
        <div class="form-group">
          <label>이미지</label>
          <div style="display: flex; gap: 10px; align-items: flex-start;">
            <div style="flex: 1;">
              <input type="file" id="caseImageFile" accept="image/*" onchange="handleImageUpload('caseImageFile', 'caseImagePreview', 'caseImage')" style="margin-bottom: 10px;">
              <input type="text" id="caseImage" placeholder="또는 이미지 URL 입력 (https://...)" style="margin-top: 10px;">
            </div>
            <div id="caseImagePreview" style="width: 150px; min-height: 100px; border: 1px solid #ddd; border-radius: 6px; padding: 10px; display: none;">
              <img id="caseImagePreviewImg" src="" style="max-width: 100%; max-height: 150px; display: none;">
              <div id="caseImagePreviewText" style="font-size: 12px; color: #666; display: none;"></div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label>첨부 파일</label>
          <input type="file" id="caseAttachment" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip">
          <div id="caseAttachmentList" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
        </div>
        <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
          <button type="button" onclick="closeModal()" style="padding: 10px 20px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer;">취소</button>
          <button type="submit" class="btn-primary">저장</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const CASES_STORAGE_KEY = 'mna_station_cases';

    function loadCases() {
      const cases = JSON.parse(localStorage.getItem(CASES_STORAGE_KEY) || '[]');
      const tbody = document.getElementById('casesList');
      
      // 최신순 정렬
      cases.sort((a, b) => new Date(b.createdAt || b.updatedAt) - new Date(a.createdAt || a.updatedAt));
      
      if (cases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 40px;">등록된 사례가 없습니다.</td></tr>';
        return;
      }

      tbody.innerHTML = cases.map((item, index) => {
        const date = new Date(item.createdAt || item.updatedAt).toLocaleDateString('ko-KR');
        return `
          <tr>
            <td>${cases.length - index}</td>
            <td>${item.title || '(제목 없음)'}</td>
            <td>${date}</td>
            <td>
              <button onclick="editCase('${item.id}')" style="padding: 5px 10px; background: #4db7ff; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px;">수정</button>
              <button onclick="deleteCase('${item.id}')" style="padding: 5px 10px; background: #ff5757; color: white; border: none; border-radius: 4px; cursor: pointer;">삭제</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    let uploadedFiles = [];
    let currentImageData = null;

    function handleImageUpload(fileInputId, previewId, imageInputId) {
      const fileInput = document.getElementById(fileInputId);
      const preview = document.getElementById(previewId);
      const previewImg = document.getElementById(previewId + 'Img');
      const previewText = document.getElementById(previewId + 'Text');
      const imageInput = document.getElementById(imageInputId);

      if (fileInput.files && fileInput.files[0]) {
        const file = fileInput.files[0];
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            currentImageData = e.target.result;
            previewImg.src = e.target.result;
            previewImg.style.display = 'block';
            previewText.style.display = 'none';
            preview.style.display = 'block';
            imageInput.value = e.target.result; // Base64 데이터 저장
          };
          reader.readAsDataURL(file);
        } else {
          alert('이미지 파일만 업로드 가능합니다.');
          fileInput.value = '';
        }
      }
    }

    function updateAttachmentList() {
      const list = document.getElementById('caseAttachmentList');
      if (uploadedFiles.length === 0) {
        list.innerHTML = '';
        return;
      }
      list.innerHTML = '<div class="file-preview"><strong>첨부된 파일:</strong>' + 
        uploadedFiles.map((file, index) => `
          <div class="file-item">
            <span class="file-item-name">${file.name} (${formatFileSize(file.size)})</span>
            <span class="file-item-remove" onclick="removeAttachment(${index})">삭제</span>
          </div>
        `).join('') + '</div>';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function removeAttachment(index) {
      uploadedFiles.splice(index, 1);
      updateAttachmentList();
    }

    document.getElementById('caseAttachment').addEventListener('change', function(e) {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
          uploadedFiles.push({
            name: file.name,
            type: file.type,
            size: file.size,
            data: e.target.result
          });
          updateAttachmentList();
        };
        reader.readAsDataURL(file);
      });
      e.target.value = '';
    });

    function openAddModal() {
      document.getElementById('caseId').value = '';
      document.getElementById('caseTitle').value = '';
      document.getElementById('caseDescription').value = '';
      document.getElementById('caseContent').value = '';
      document.getElementById('caseImage').value = '';
      document.getElementById('caseImageFile').value = '';
      document.getElementById('caseImagePreview').style.display = 'none';
      document.getElementById('caseImagePreviewImg').src = '';
      document.getElementById('caseAttachment').value = '';
      uploadedFiles = [];
      currentImageData = null;
      updateAttachmentList();
      document.getElementById('modalTitle').textContent = '새 사례 등록';
      document.getElementById('caseModal').style.display = 'block';
    }

    function editCase(id) {
      const cases = JSON.parse(localStorage.getItem(CASES_STORAGE_KEY) || '[]');
      const item = cases.find(c => c.id === id);
      if (!item) return;

      document.getElementById('caseId').value = id;
      document.getElementById('caseTitle').value = item.title || '';
      document.getElementById('caseDescription').value = item.description || '';
      document.getElementById('caseContent').value = item.content || '';
      document.getElementById('caseImage').value = item.image || '';
      document.getElementById('caseImageFile').value = '';
      
      // 이미지 미리보기
      const preview = document.getElementById('caseImagePreview');
      const previewImg = document.getElementById('caseImagePreviewImg');
      const previewText = document.getElementById('caseImagePreviewText');
      if (item.image) {
        if (item.image.startsWith('data:')) {
          previewImg.src = item.image;
          previewImg.style.display = 'block';
          previewText.style.display = 'none';
        } else {
          previewImg.src = item.image;
          previewImg.style.display = 'block';
          previewText.style.display = 'none';
        }
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      
      // 첨부파일 복원
      uploadedFiles = item.attachments || [];
      updateAttachmentList();
      currentImageData = item.image && item.image.startsWith('data:') ? item.image : null;
      
      document.getElementById('modalTitle').textContent = '사례 수정';
      document.getElementById('caseModal').style.display = 'block';
    }

    function saveCase(event) {
      event.preventDefault();
      const cases = JSON.parse(localStorage.getItem(CASES_STORAGE_KEY) || '[]');
      const id = document.getElementById('caseId').value;
      
      const imageValue = document.getElementById('caseImage').value;
      const imageToSave = currentImageData || (imageValue.startsWith('data:') ? imageValue : (imageValue || null));
      
      const caseData = {
        id: id || 'case_' + Date.now(),
        title: document.getElementById('caseTitle').value,
        description: document.getElementById('caseDescription').value,
        content: document.getElementById('caseContent').value,
        image: imageToSave,
        attachments: uploadedFiles.length > 0 ? uploadedFiles : undefined,
        createdAt: id ? cases.find(c => c.id === id).createdAt : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };

      if (id) {
        const index = cases.findIndex(c => c.id === id);
        if (index !== -1) {
          cases[index] = caseData;
        }
      } else {
        cases.push(caseData);
      }

      localStorage.setItem(CASES_STORAGE_KEY, JSON.stringify(cases));
      loadCases();
      closeModal();
      alert('저장되었습니다.');
    }

    function deleteCase(id) {
      if (!confirm('정말 삭제하시겠습니까?')) return;
      
      const cases = JSON.parse(localStorage.getItem(CASES_STORAGE_KEY) || '[]');
      const filtered = cases.filter(c => c.id !== id);
      localStorage.setItem(CASES_STORAGE_KEY, JSON.stringify(filtered));
      loadCases();
      alert('삭제되었습니다.');
    }

    function closeModal() {
      document.getElementById('caseModal').style.display = 'none';
    }

    // 모달 외부 클릭 시 닫기
    document.getElementById('caseModal').addEventListener('click', function(e) {
      if (e.target === this) {
        closeModal();
      }
    });

    loadCases();
  </script>
</body>
</html>

